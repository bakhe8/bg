# BGL_Lite — تقرير الاستعداد للإصدار الأول

## 1. نظرة عامة
- يقوم **BGL_Lite** بتحويل ملفات Excel الخاصة بخطابات الضمان إلى بيانات منظمة، ويتيح مراجعتها، اعتمادها، وتوليد خطابات PDF عربية بنفس القالب الرسمي.
- خط المعالجة الرئيس مكوّن من: استيراد Excel → تنظيف وتطبيع (مع تعريب الأرقام والأسماء) → حفظ ناتج JSON ومراجعة تفصيلية → اعتماد السجلات وتوليد ملفات PDF → معاينة أو تصدير نهائي.
- يعتمد التطبيق على **tkinter + ttkbootstrap** لواجهة واحدة تحتوي على صفحات: الرئيسية، المراجعة، التعلّم، التصدير (app/gui/main_app.py:1).

## 2. لمحة معمارية
| الطبقة | الملفات الأساسية | الملاحظات |
|--------|------------------|-----------|
| معالجة البيانات | `app/core/processor.py`, `app/core/normalizer.py`, `app/core/autofill.py` | مسؤول عن قراءة Excel، اكتشاف الأعمدة، تطبيع النصوص، وتوليد تقارير المراجعة (processor.py:1-200). |
| التوليد الطباعي | `app/core/pdf_generator.py`, `app/templates/*` | يستخدم WeasyPrint مع قالب HTML/CSS وخطوط مدمجة. |
| الواجهة الرسومية | `app/gui/main_app.py`, `app/gui/pages/*` | نافذة واحدة مع شريط جانبي ديناميكي وأربع صفحات محتوى. |
| المعاينة | `app/gui/pdf_viewer.py` | يحاول استخدام WebView2 عبر pywebview، مع رجوع تلقائي إلى `os.startfile` في حال عدم توفره (pdf_viewer.py:1-71). |
| المستندات والاختبارات | `docs/*.md`, `tests/*.py` | تغطي المواصفات، السيناريوهات، وبعض اختبارات الوحدة والتكامل. |

## 3. تدفق البيانات
1. **تحميل الملف**: `MainApp.choose_excel_file` يمرر المسار إلى `process_excel` ثم `process_file` (app/gui/main_app.py:170-212).
2. **قراءة Excel**: `load_dataframe` يزيل المحارف الخفية ويعالج الأعمدة المكررة مع تسجيل تقرير تنظيف الأعمدة (app/core/processor.py:169-199).
3. **تطبيع السجلات**: `normalize_record` يوحّد أسماء البنوك والمبالغ والتواريخ (app/core/normalizer.py:1-63). كما يتم بناء سجل للتعلم الآلي للبنوك والموردين غير المعروفين (processor.py:220-330 تقريبًا).
4. **حفظ المخرجات**: يتم حفظ `output.json`, `approved.json`, `review_report.json` في `data/output/` مع تحديث إحصاءات الصفحة الرئيسية (app/core/processor.py:360-420 + main_app).
5. **المراجعة والاعتماد**: `ReviewPage` تعرض السجلات القابلة للمراجعة، وتقوم بكتابة الاعتمادات بنفس الصيغة (app/gui/pages/review_page.py:27-201).
6. **التصدير**: `PDFGenerator.generate_letter` يولد ملف PDF واحد استنادًا إلى قالب HTML/CSS (app/core/pdf_generator.py:55-82)، ويمكن توليد دفعات باستخدام `generate_pdf`.

## 4. واجهة المستخدم
- **الشريط الجانبي**: يحتوي على أزرار التنقل وأزرار التحكم الخاصة بكل صفحة (main_app.py:95-162).
- **HomePage**: تعرض حالة آخر معالجة، الإحصاءات، والتنبيهات بدون أزرار فعلية داخل المحتوى (app/gui/pages/home_page.py:9-87).
- **ReviewPage**: جدول متعدد الأعمدة مع شريط حالة يوضح جاهزية المعاينة والتصدير، وزر “معاينة PDF” في الشريط الأيمن يمر عبر `open_pdf_viewer` (app/gui/pages/review_page.py:15-201).
- **LearningPage**: تعرض العناصر “القابلة للتعلم” (بنوك/موردون) وتسمح بإضافتها/إزالتها من القائمة اليمنى (app/gui/pages/learning_page.py:1-56).
- **ExportPage**: ملخص السجلات المعتمدة، توضح المسار النهائي وتعليمات التصدير (app/gui/pages/export_page.py:1-46).

## 5. التوليد الطباعي والمعاينة
- قالب HTML: `app/templates/letter_template.html` + `letter_template.css` يحاكي التصميم المطلوب بالكامل (موضوع ملوّن، خلفية SVG، خطوط AlMohanad/Roboto).
- `PDFGenerator` يستخدم WeasyPrint ويقرأ إعداداته من `app/config/pdf_settings.json`. أي خطأ في WeasyPrint يظهر كاستثناء واضح للمستخدم.
- `show_pdf_in_app` يحاول عرض الملف داخل WebView2، وإذا تعذر (غياب runtime أو فشل pythonnet) يعود مباشرة إلى العارض الافتراضي للنظام لضمان عدم تعطل سير العمل (app/gui/pdf_viewer.py:16-70).

## 6. الملفات والمثابرة
- ملفات الإعدادات/القواميس موجودة داخل `config/` (banks_dict.json, suppliers_dict.json, schema_ref.json).
- المخرجات تُكتب في `data/output/` مع ضمان إنشاء المجلد عند التشغيل (processor.py:27-63 + main_app.py:42-48).
- التعلم المستقبلي للبنوك/الموردين يحدّث ملفات القواميس عبر `add_learnable_item` في `MainApp` (app/gui/main_app.py:322-366).

## 7. الاعتمادات والبناء
- الاعتمادات الرئيسية محددة في `requirements-lite.txt` وتشمل pandas، weasyprint، rapidfuzz، ttkbootstrap، و **pywebview** (requirements-lite.txt).
- سكربت البناء `build_portable_lite.py` تم تحديثه لإضافة `--hidden-import=webview` و`webview.platforms.edgechromium` لضمان دمج العارض داخل نسخة PyInstaller (build_portable_lite.py:8-27).
- WebView2 Runtime ليس جزءًا من التوزيع لكنه متوفر افتراضيًا في Windows 10/11؛ عند غيابه يتم الرجوع للعارض الخارجي تلقائيًا.

## 8. الاختبارات الحالية
| الملف | الهدف |
|-------|-------|
| `tests/test_normalizer.py` | يتحقق من تعريب المبالغ والمعايير البنكية (التأكد من المخرجات العربية). |
| `tests/test_processor.py` | اختبار تكامل مبسط يقرأ ملف Excel عيّنة ويتأكد من عدد السجلات والأسماء. |
| `tests/test_integration.py`, `test_performance.py` | تغطي سيناريوهات أوسع (تحميل ملفات متعددة، التحقق من الأداء). |
| `tests/ui_manual_checklist.md` | قائمة تحقق يدوية للواجهة (تحميل، اعتماد، تصدير، التعلّم). |

**المطلوب قبل الإصدار:**
- تشغيل `pytest` على الأقل مرة واحدة داخل بيئة الإنتاج المستهدفة.
- تحديث العينات في `tests/output_samples/` بعد أي تعديل على القالب أو المعالجة.

## 9. المخاطر والفجوات
1. **اعتماد المعاينة على pythonnet**: ما زال `pywebview` يعتمد على pythonnet؛ على Python 3.14 يتم الرجوع للعارض الخارجي. حل قصير المدى: استخدام Python 3.12 أو انتظار دعم pythonnet الرسمي للإصدارات الأحدث.
2. **اختبارات واجهة محدودة**: لا توجد اختبارات آلية للـ GUI؛ يجب الالتزام بقائمة التحقق اليدوية (`tests/ui_manual_checklist.md`) لكل إصدار.
3. **إدارة الأخطاء**: عند فشل WeasyPrint أو قراءة Excel تُظهر Messagebox الخطأ، لكن لا يوجد تسجيل (logging) مفصّل. يُستحسن إضافة ملف log لاحقًا.
4. **الوثائق**: المستندات الحالية كثيرة لكنها قديمة (تاريخ 2025-11). تم توثيق الحالة الراهنة في هذا الملف لكن يُفضّل تحديث الأدلة الأخرى.

## 10. قائمة الاستعداد للإصدار الأول
1. **بيئة التشغيل**
   - تأكد من تثبيت Python 3.12 (أو بيئة مدعومة من pythonnet) وتشغيل `pip install -r requirements-lite.txt`.
   - جرّب `py -3.12 -m venv .venv && .venv\\Scripts\\activate` لتوفير بيئة نظيفة.
2. **الاختبارات**
   - نفّذ `pytest tests` وتحقق من نجاح `test_processor` و`test_normalizer`.
   - اتبع `tests/ui_manual_checklist.md` للتأكد من السلوك البصري (تحميل → مراجعة → اعتماد → تعلّم → تصدير → معاينة).
3. **الجودة الطباعية**
   - شغّل `python -m app.core.processor data/samples/test.xlsx`.
   - افتح آخر سجل من صفحة المراجعة، توليد PDF، وقارن الملف الناتج مع القالب المرجعي يدويًا.
4. **المعاينة**
   - على جهاز يحتوي WebView2، اختبر زر “معاينة PDF”. على جهاز بدون WebView2 تأكد من أن العارض الخارجي يعمل.
5. **الحزم والتوزيع**
   - نفّذ `python build_portable_lite.py` ثم اختبر الملف التنفيذي الناتج على جهاز نظيف (أو VM) للتحقق من تضمين القواميس والقوالب.
   - حدّث `docs/README_UserGuide.md` أو ملفًا مصاحبًا يشرح خطوات الاستخدام للمستخدم النهائي.
6. **ما بعد الإصدار**
   - جهّز خطة دعم للأخطاء الحرجة.
   - سجّل قائمة التحسينات المستقبلية (مثل دمج المعاينة داخل النافذة الرئيسية عند توفر Python مدعوم).

باتباع البنود أعلاه يصبح المشروع جاهزًا لإصدار نسخة أولى موثوقة.
