<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ورقة اختبار خطابات الضمان</title>
  <style>
    @font-face {
      font-family: 'AlMohanad';
      src: url("assets/AL-Mohanad Bold.ttf") format("truetype");
      font-weight: bold;
      font-style: normal;
      font-display: swap;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "AlMohanad", "Segoe UI", Tahoma, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      background: #f5f6fa;
      padding: 0;
    }

    .toolbar {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 10;
    }

    .toolbar button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      background: #0b6fa4;
      color: #fff;
      box-shadow: 0 8px 18px rgba(11, 111, 164, 0.25);
    }

    .toolbar button:hover {
      opacity: 0.9;
    }

    .letter-sheet {
      width: 210mm;
      height: 297mm;
      margin: 0;
      padding: 0;
      border: none;
      border-radius: 0;
      box-shadow: none;
      position: relative;
      overflow: hidden;
    }

    .letterhead {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      user-select: none;
    }

    .sheet-content {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      padding: 60mm 25mm 25mm;
    }

    .writing-area {
      width: 100%;
      flex: 1;
      min-height: 0;
      border: 1.5px dashed rgba(0, 128, 0, 0.35);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.55);
      padding: 10mm;
      overflow: auto;
      font-size: 1.05rem;
      line-height: 1.8;
      outline: none;
    }

    .writing-area:focus {
      border-color: #0b6fa4;
      box-shadow: 0 0 0 2px rgba(11, 111, 164, 0.15);
    }

    .page-footer {
      margin: 0;
      padding: 0;
      width: 210mm;
      border: none;
      background: transparent;
      font-weight: 600;
      text-align: left;
      outline: none;
    }

    h1 {
      margin-top: 0;
      font-size: 1.4rem;
      color: #0b6fa4;
      text-align: center;
    }

    textarea {
      width: 100%;
      min-height: 300px;
      padding: 16px;
      font-family: inherit;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      resize: vertical;
      background: rgba(255, 255, 255, 0.9);
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="downloadBtn">تحميل PDF</button>
  </div>
  <main class="letter-sheet">
    <img alt="ورقة رسمية" class="letterhead" id="letterhead">
    <div class="sheet-content">
      <section class="writing-area" contenteditable="true" aria-label="منطقة الكتابة">
        <div class="preview-container" id="previewContainer">
                <div class="preview-header">
                    <div class="preview-recipient">
                        <div class="bold">السـادة / البنك الأهلي التجاري</div>
                    </div>
                    <div class="preview-salutation">
                        <div>المحترمين</div>
                    </div>
                </div>
                
                <div class="preview-sender-info">
                    <div class="bold">شركة رؤية القوى للمصاعد</div>
                    <div>الرياض، المملكة العربية السعودية</div>
                    <div>info@alrajhibank.com</div>
                </div>
                
                <div class="preview-greeting">
                    <div>السَّلام عليكُم ورحمَة الله وبركاتِه</div>
                </div>
                
                <div class="preview-subject">
                    <div class="preview-subject-label">الموضوع:</div>
                    <div>
                        طلب تمديد الضمان البنكي رقم (GB202400123) والعائد للعقد رقم (CONTRACT-2024-456).
                    </div>
                </div>
                
                <div class="preview-content">
                    <p>
                        إشارة الى الضمان البنكي النهائي الموضح أعلاه، والصادر منكم لصالحنا على حساب شركة رؤية القوى للمصاعد 
                        بمبلغ قدرة (500,000) ريال نأمل منكم تمديد فترة سريان الضمان حتى تاريخ ٣٠ جمادى الآخرة ١٤٤٦ هـ، 
                        مع بقاء الشروط الأخرى دون تغيير، وإفادتنا بذلك من خلال البريد الالكتروني المخصص للضمانات البنكية لدى مستشفى 
                        الملك فيصل التخصصي ومركز الأبحاث بالرياض (bgfinance@kfshrc.edu.sa)، 
                        كما نأمل منكم إرسال أصل تمديد الضمان الى:
                    </p>
                    
                    <div class="preview-address-box">
                        <div class="bold">مستشفى الملك فيصل التخصصي ومركز الأبحاث - الرياض</div>
                        <div>ص.ب 3354 الرياض 11211</div>
                        <div>مكتب الخدمات الإدارية</div>
                    </div>
                    
                    <p>
                        علمًا بأنه في حال عدم تمكن البنك من تمديد الضمان المذكور قبل إنتهاء مدة سريانه فيجب على البنك دفع 
                        قيمة الضمان الينا حسب النظام.
                    </p>
                    
                    <p style="margin-top: 25px;">وَتفضَّلوا بِقبُول خَالِص تحيَّاتي</p>
                </div>
                
                <div class="preview-clearfix">
                    <div class="preview-signature">
                        <div class="bold">مُدير الإدارة العامَّة للعمليَّات المحاسبيَّة</div>
                        <div class="bold">سَامِي بن عبَّاس الفايز</div>
                    </div>
                </div>
            </div>
      </section>
      <span aria-label="initil">BAMZ</span>
    </div>
  </main>

  <script src="assets/letterhead-data.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const letterSheet = document.querySelector('.letter-sheet');
    const btn = document.getElementById('downloadBtn');
    const letterhead = document.getElementById('letterhead');
    if (typeof letterheadDataUrl !== 'undefined') {
      letterhead.src = letterheadDataUrl;
    }

    function setButtonState(message, disabled = false) {
      btn.textContent = message;
      btn.disabled = disabled;
      btn.style.opacity = disabled ? 0.5 : 1;
    }

    function evaluateReadyState() {
      if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
        setButtonState('تعذر تحميل محرك PDF', true);
        return false;
      }

      if (!letterhead.src) {
        setButtonState('الخلفية غير جاهزة', true);
        return false;
      }

      if (!letterhead.complete || letterhead.naturalWidth === 0) {
        setButtonState('جاري تحميل الخلفية...', true);
        return false;
      }

      setButtonState('تحميل PDF');
      return true;
    }

    letterhead.addEventListener('load', evaluateReadyState);
    letterhead.addEventListener('error', () => setButtonState('تعذر تحميل الخلفية', true));
    evaluateReadyState();

    btn.addEventListener('click', async () => {
      if (!evaluateReadyState()) {
        return;
      }

      setButtonState('جاري التحويل...', true);
      try {
      const canvas = await html2canvas(letterSheet, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          scrollX: 0,
          scrollY: -window.scrollY
        });

        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
        pdf.save('letter.pdf');
        setButtonState('تحميل PDF');
      } catch (error) {
        console.error(error);
        setButtonState('حدث خطأ، أعد المحاولة', false);
      }
    });
  </script>
</body>
</html>

